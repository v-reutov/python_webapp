{% extends 'ontogen/base.html' %}
{% load i18n %}
{% load static %}

{% block content %}
{% trans "Back to repository tree" as back_button %}

<h1>{% trans "Generating ontology" %}</h1>
<div id="split-wrapper">
    <div>
        {{ instruction.instruction_content | safe }}
    </div>
    <div id="rightBar">
        <!-- <div class="panel-group" id="accordion">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h4 class="panel-title">
                        <a data-toggle="collapse" data-parent="#accordion" href="#collapse1">Шаг 1. Построение предметной онтологии</a>
                    </h4>
                </div>
                <div id="collapse1" class="panel-collapse collapse in">
                    <div class="panel-body">
                        <p>Выделите фрагмент инструкции, описывающий состав изделия, а затем нажмите на кнопку "Построить предметную онтологию".</p>
                        <input type="button" value="Построить предметную онтологию" onclick="buildSubjectOntology();"/>
                        <div id="subject-ontology-vis" class="vis"></div>
                    </div>
                </div>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h4 class="panel-title">
                        <a data-toggle="collapse" data-parent="#accordion" href="#collapse2">Шаг 2. Обогащение предметной онтологии</a>
                    </h4>
                </div>
                <div id="collapse2" class="panel-collapse collapse">
                    <div class="panel-body">
                        Предметную онтологию можно пополнить с помощью изображений. Нажмите на нужное изображение, затем выделите его часть зажав левую кнопку мыши.
                        Выделенный фрагмент будет продублирован ниже.

                        <canvas id="preview"></canvas>
                        <p id="preview-ocr"></p>
                    </div>
                </div>
            </div>
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h4 class="panel-title">
                        <a data-toggle="collapse" data-parent="#accordion" href="#collapse3">Шаг 3. Построение онтологии задачи</a>
                    </h4>
                </div>
                <div id="collapse3" class="panel-collapse collapse">
                    <div class="panel-body">Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore
                        et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi
                        ut aliquip ex ea commodo consequat.</div>
                </div>
            </div>
        </div> -->
    
        <div id="tab-container">
            
            <!-- One "tab" for each step in the form: -->
            <div class="tab">
                <p>Шаг 1. Построение предметной онтологии</p>
                <p>Выделите фрагмент инструкции, описывающий состав изделия, а затем нажмите на кнопку "Далее"</p>
                <input type="button" value="Построить предметную онтологию" onclick="buildSubjectOntology();"/>
                <div id="subject-ontology-vis" class="vis"></div>
            </div>
            
            <div class="tab">
                <p>Шаг 2. Обогащение предметной онтологии</p>
                <p>Предметную онтологию можно пополнить с помощью изображений. Нажмите на нужное изображение, затем выделите его часть зажав левую кнопку мыши. 
                    Выделенный фрагмент будет продублирован ниже.</p>
                <canvas id="preview"></canvas>
                <p id="preview-ocr"></p></p>
            </div>
            
            <div class="tab">Birthday:
                <p><input placeholder="dd" oninput="this.className = ''"></p>
                <p><input placeholder="mm" oninput="this.className = ''"></p>
                <p><input placeholder="yyyy" oninput="this.className = ''"></p>
            </div>
            
            <div class="tab">Login Info:
                <p><input placeholder="Username..." oninput="this.className = ''"></p>
                <p><input placeholder="Password..." oninput="this.className = ''"></p>
            </div>
            
            <!-- <div style="overflow:auto;">
                <div style="float:right;">
                <button type="button" id="prevBtn" onclick="nextPrev(-1)">Previous</button>
                <button type="button" id="nextBtn" onclick="nextPrev(1)">Next</button>
                </div>
            </div> -->
            
            <!-- Circles which indicates the steps of the form: -->
            <div style="text-align:center;margin-top:10px">
                <span class="step"></span>
                <span class="step"></span>
                <span class="step"></span>
                <span class="step"></span>
            </div>
        </div>

        <!-- <ul class="nav nav-pills nav-justified">
            <li class="active"><a href="#">Предметная онтология</a></li>
            <li><a href="#">Прикладная онтология</a></li>
        </ul> -->
        <div id="ontology-container" style="display:none"></div>
        <!-- <div id="subject-ontology-vis" class="vis"></div> -->
    </div>
</div>

{% endblock %}

{% block head %}
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script type="text/javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

<script type="text/javascript" src="{% static 'ontogen/lib/jcrop/jquery.Jcrop.min.js' %}"></script>
<link rel="stylesheet" href="{% static 'ontogen/lib/jcrop/jquery.Jcrop.min.css' %}">

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.css">

<script type="text/javascript" src="{% static 'ontogen/ontology/visualize.js' %}"></script>
<script type="text/javascript" src="{% static 'ontogen/lib/ocrad/ocrad.js' %}"></script>

{% comment %} <script src='https://cdn.rawgit.com/naptha/tesseract.js/1.0.10/dist/tesseract.js'></script> {% endcomment %}

<script>
    var patterns = JSON.parse('{{ patterns }}');
    var subject_ontology;

    var jcrop_api;
    var jcrop_enabled = true;
    var jcrop_target;

    var previewXStart;
    var previewYStart;
    var previewHeight;
    var previewWidth;

    var currentTab = 0; // Current tab is set to be the first tab (0)

    $(document).ready(function () {
        showTab(currentTab); // Display the current tab

        function saveTextAsFile(prefix) {
            var textToWrite = document.getElementById(prefix + "-ontology").value;
            var textFileAsBlob = new Blob([textToWrite], {
                type: 'text/plain'
            });
            var fileNameToSaveAs = $("#ontology-prefix").text() + " " + prefix + "-ontology.ont";
            var downloadLink = document.createElement("a");

            downloadLink.download = fileNameToSaveAs;
            downloadLink.innerHTML = "My Hidden Link";
            window.URL = window.URL || window.webkitURL;
            downloadLink.href = window.URL.createObjectURL(textFileAsBlob);
            downloadLink.onclick = destroyClickedElement;
            downloadLink.style.display = "none";
            document.body.appendChild(downloadLink);
            downloadLink.click();
        }

        function destroyClickedElement(event) {
            document.body.removeChild(event.target);
        }

        $("#download-subject").click(function (e) {
            e.preventDefault();
            saveTextAsFile("subject");
        });

        $("#download-applied").click(function (e) {
            e.preventDefault();
            saveTextAsFile("applied");
        });

        $('img').each(function() {
            this.onclick = function() {
                if (!jcrop_enabled) return;

                destroyJcropIfAny();
                
                jcrop_target = this;

                $(this).Jcrop({
                    onChange: updatePreview,
                    onSelect: onSelectChanged,
                    // aspectRatio : 1,
                }, function() {
                        jcrop_api = this;
                    }
                );
            }
        });

        $(document).keyup(function(e) {
            if (e.keyCode == 27) {
                destroyJcropIfAny();
            }
        });

        var canvas = $("#preview")[0];
        
        canvas.width  = 400;
        canvas.height = 250;

        canvas.style.height = canvas.height;
        canvas.style.width = canvas.width;
    });

    function destroyJcropIfAny() {
        if (jcrop_api !== undefined) {
                jcrop_api.destroy();
                jcrop_api = undefined;
        }
    }

    function updatePreview(crop) {
        if(parseInt(crop.w) > 0) {
            // Show image preview
            var canvas = $("#preview")[0];
            var context = canvas.getContext("2d");
            context.clearRect(0, 0, canvas.width, canvas.height);
            
            fitImageOn(canvas, jcrop_target, crop);
        }
    };

    function onSelectChanged(crop) {
        if(parseInt(crop.w) > 0) {
            updatePreview(crop);
            recognizeNumber();
        }
    }

    function fitImageOn(canvas, imageObj, crop) {
        var context = canvas.getContext("2d");

        var imageAspectRatio = crop.w / crop.h;
        var canvasAspectRatio = canvas.width / canvas.height;
        var renderableHeight, renderableWidth, xStart, yStart;
    
        if(imageAspectRatio < canvasAspectRatio) {
            renderableHeight = canvas.height;
            renderableWidth = crop.w * (renderableHeight / crop.h);
            xStart = (canvas.width - renderableWidth) / 2;
            yStart = 0;
        }
    
        else if(imageAspectRatio > canvasAspectRatio) {
            renderableWidth = canvas.width
            renderableHeight = crop.h * (renderableWidth / crop.w);
            xStart = 0;
            yStart = (canvas.height - renderableHeight) / 2;
        }

        else {
            renderableHeight = canvas.height;
            renderableWidth = canvas.width;
            xStart = 0;
            yStart = 0;
        }

        previewXStart = xStart;
        previewYStart = yStart;
        previewHeight = renderableHeight;
        previewWidth  = renderableWidth;

        context.drawImage(jcrop_target, crop.x, crop.y, crop.w, crop.h, xStart, yStart, renderableWidth, renderableHeight);
    };

    function recognizeNumber() {
        var canvas = document.getElementById("preview");
        var context = canvas.getContext("2d");
        
        var imageData = context.getImageData(previewXStart, previewYStart, previewWidth, previewHeight);
        
        OCRAD(imageData, {
            numeric: true
        }, function(text) {
            document.getElementById('preview-ocr').innerText = text;
        })

        //Tesseract.recognize(imageData, {
        //    tessedit_char_whitelist: '0123456789'
        //})
        //.then(function(result) {
        //    document.getElementById('preview-ocr').innerText = result.text;
        //})
    }

    function buildSubjectOntology() {
        text = window.getSelection().toString();

        if (text === undefined || text === "") {
            alert('{% trans "No text was selected." %}');
            return;
        }

        post_data = {
            'text': text,
            'patterns': patterns
        }

        $.post("{% url 'ontogen:generate_subject' %}", post_data, function (response) {
            if (response.status == "OK") {
                subject_ontology = response.result;

                var container = document.getElementById('ontology-container');
                intializeOntology(container, response.result);

                container.getElementsByClassName('vis-network')[0].style.position = 'absolute';
                container.style.display = '';

                nextPrev(1);
            } else {
                alert('Something went wrong');
            }
        });
    }

    function showTab(n) {
        // This function will display the specified tab of the form ...
        var x = document.getElementsByClassName("tab");
        x[n].style.display = "block";
        // ... and fix the Previous/Next buttons:
        // if (n == 0) {
        //     document.getElementById("prevBtn").style.display = "none";
        // } else {
        //     document.getElementById("prevBtn").style.display = "inline";
        // }
        // if (n == (x.length - 1)) {
        //     document.getElementById("nextBtn").innerHTML = "Submit";
        // } else {
        //     document.getElementById("nextBtn").innerHTML = "Next";
        // }
        // ... and run a function that displays the correct step indicator:
        fixStepIndicator(n)
    }

    function nextPrev(n) {
        // This function will figure out which tab to display
        var x = document.getElementsByClassName("tab");
        x[currentTab].style.display = "none";

        // Increase or decrease the current tab by 1:
        currentTab = currentTab + n;
        // if you have reached the end of the form... :
        if (currentTab >= x.length) {
            return false;
        }
        // Otherwise, display the correct tab:
        showTab(currentTab);
    }

    function fixStepIndicator(n) {
        // This function removes the "active" class of all steps...
        var i, x = document.getElementsByClassName("step");
        for (i = 0; i < x.length; i++) {
            x[i].className = x[i].className.replace(" active", "");
        }
        //... and adds the "active" class to the current step:
        x[n].className += " active";
    }
</script>
<style>
    #split-wrapper {
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        height: 100%;

        flex: 1 1 auto;
    }

    #split-wrapper > div {
        flex: 0 1 50%;
    }

    .vis {
        background-color: red;

        position:absolute;
        width:100%;
        height:100%;
    }

    .vis:empty {
        display: none;
    }

    #preview {
        overflow:hidden;
        display:block;
        border: 1px solid lightgray;
        margin-top: 10px;
    }

    #rightBar {
        display: flex;
        flex-direction: column;
    }

    #tab-container {
        background-color: #ffffff;
        padding: 20px;
        width: 100%;
        min-width: 300px;

        border: 1px solid lightgray;
        border-radius: 5px;
    }

    #ontology-container {
        margin-top: 10px;
        flex-grow: 1;

        border: 1px solid lightgray;
        border-radius: 5px;

        overflow: hidden;
        position:relative;
    }

    #ontology-container:empty {
        /*display: none;*/
    }
    
    /* Style the input fields */
    
    #tab-container input {
        padding: 10px;
        width: 100%;
        font-size: 17px;
        font-family: Raleway;
        border: 1px solid #aaaaaa;
    }
    
    /* Mark input boxes that gets an error on validation: */
    
    #tab-container input.invalid {
        background-color: #ffdddd;
    }
    
    /* Hide all steps by default: */
    
    .tab {
        display: none;
    }
    
    /* Make circles that indicate the steps of the form: */
    
    .step {
        height: 15px;
        width: 15px;
        margin: 0 2px;
        background-color: #bbbbbb;
        border: none;
        border-radius: 50%;
        display: inline-block;
        opacity: 0.5;
    }
    
    /* Mark the active step: */
    
    .step.active {
        opacity: 1;
    }
    
    /* Mark the steps that are finished and valid: */
    
    .step.finish {
        background-color: #4CAF50;
    }
</style>
{% endblock %}